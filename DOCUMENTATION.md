# 🏪 망원동 상권 에이전트 시뮬레이션 - 기술 문서

> Stanford Generative Agents + H3 Spatial Indexing 기반 상권 시뮬레이션 시스템

---

## 📑 목차

1. [프로젝트 아키텍처](#1-프로젝트-아키텍처)
2. [파일 구조 및 역할](#2-파일-구조-및-역할)
3. [데이터 흐름도](#3-데이터-흐름도)
4. [에이전트 생성 과정](#4-에이전트-생성-과정)
5. [환경 구축 (H3 공간 인덱싱)](#5-환경-구축-h3-공간-인덱싱)
6. [시뮬레이션 실행 과정](#6-시뮬레이션-실행-과정)
7. [에이전트 인지-판단-행동 사이클](#7-에이전트-인지-판단-행동-사이클)
8. [시간/요일별 활동 가중치 시스템](#8-시간요일별-활동-가중치-시스템)
9. [비즈니스 리포트 반응 메커니즘](#9-비즈니스-리포트-반응-메커니즘)
10. [결과 분석 및 시각화](#10-결과-분석-및-시각화)

---

## 1. 프로젝트 아키텍처

### 1.1 전체 시스템 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    Mangwon-sim System                        │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │   Data Layer │    │ Agent Layer  │    │ Spatial Layer│  │
│  │              │    │              │    │              │  │
│  │ • stores.csv │───▶│ • Persona    │◀───│ • H3 Grid   │  │
│  │ • 인구_DB.json│    │ • Memory     │    │ • Environment│  │
│  │              │    │ • Decision   │    │ • Perception │  │
│  └──────────────┘    └──────────────┘    └──────────────┘  │
│         │                    │                    │          │
│         └────────────────────┼────────────────────┘          │
│                              ▼                               │
│                    ┌──────────────────┐                      │
│                    │ Simulation Engine│                      │
│                    │                  │                      │
│                    │ • Time Control   │                      │
│                    │ • Event Logger   │                      │
│                    │ • Report System  │                      │
│                    └──────────────────┘                      │
│                              │                               │
│                              ▼                               │
│                    ┌──────────────────┐                      │
│                    │  Analysis Layer  │                      │
│                    │                  │                      │
│                    │ • Statistics     │                      │
│                    │ • Visualization  │                      │
│                    └──────────────────┘                      │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 핵심 컴포넌트

| 컴포넌트 | 역할 | 기술 스택 |
|---------|------|----------|
| **Data Layer** | 매장/인구 데이터 관리 | CSV, JSON |
| **Agent Layer** | 에이전트 생성 및 행동 | Python, Dataclasses |
| **Spatial Layer** | 공간 인덱싱 및 탐색 | H3-Py (Uber) |
| **Simulation Engine** | 시뮬레이션 실행 | Pandas, Datetime |
| **Analysis Layer** | 결과 분석 및 통계 | Pandas, Statistics |

---

## 2. 파일 구조 및 역할

### 2.1 디렉토리 구조

```
khai-agent/
│
├── 📊 Data Files (입력 데이터)
│   ├── stores.csv              # 망원동 매장 데이터 (756개)
│   └── 인구_DB.json             # 인구 통계 데이터
│
├── 🔧 Core Modules (핵심 모듈)
│   ├── h3_spatial_indexing.py   # H3 공간 인덱싱 시스템
│   ├── agent_generator.py       # 에이전트 생성기
│   └── simulation_engine.py     # 시뮬레이션 엔진
│
├── 📈 Analysis Tools (분석 도구)
│   ├── analyze_results.py       # 결과 분석 스크립트
│   └── check_h3_resolution.py   # H3 격자 정보 확인
│
├── 🎯 Output Files (출력 데이터)
│   ├── agents.json              # 생성된 에이전트 데이터
│   ├── simulation_result.csv    # 전체 시뮬레이션 로그
│   └── visit_log.csv            # 방문 이벤트 로그
│
├── 🚀 Execution Scripts (실행 스크립트)
│   ├── run_simulation.bat       # 전체 실행 (Windows)
│   ├── run_analysis.bat         # 분석 실행 (Windows)
│   └── run_analysis.ps1         # 분석 실행 (PowerShell)
│
└── 📖 Documentation (문서)
    ├── README.md                # 프로젝트 개요
    ├── DOCUMENTATION.md         # 기술 문서 (이 파일)
    └── requirements.txt         # 필수 라이브러리
```

### 2.2 파일별 상세 역할

#### 🔵 h3_spatial_indexing.py
**역할**: 공간 인덱싱 및 매장 탐색

```python
class Environment:
    """H3 그리드 기반 공간 환경"""

    def __init__(self, stores_df, h3_resolution=10):
        # 매장 데이터를 H3 격자로 인덱싱

    def get_visible_stores(self, lat, lng, k_ring=1):
        # 특정 위치에서 주변 매장 탐색

    def generate_observation_prompt(self, lat, lng):
        # 에이전트용 관찰 프롬프트 생성
```

**핵심 기능**:
- 위경도 좌표 → H3 인덱스 변환
- 주변 격자 탐색 (k_ring=1, 반경 127m)
- 매장 정보를 자연어로 변환

---

#### 🔵 agent_generator.py
**역할**: 인구 통계 기반 에이전트 생성

```python
class PopulationStatistics:
    """인구 통계 데이터 관리"""

    def __init__(self, json_path, area_code, quarter):
        # 인구_DB.json 파싱

    def get_random_age_group(self):
        # 통계 기반 연령대 선택

    def get_time_weight(self, time_slot):
        # 시간대별 활동 가중치

class AgentGenerator:
    """에이전트 생성기"""

    def generate_agent(self, agent_id):
        # 단일 에이전트 생성

    def generate_agents(self, num_agents=20):
        # 다수 에이전트 생성
```

**핵심 기능**:
- 실제 인구 구성비 반영
- 페르소나 자동 생성 (나이, 직업, 선호도 등)
- 민감도 계산 (가격/트렌드/품질)

---

#### 🔵 simulation_engine.py
**역할**: 시뮬레이션 실행 및 이벤트 로깅

```python
class SimulationEngine:
    """시뮬레이션 엔진"""

    def __init__(self, environment, stats, agents):
        # 환경, 통계, 에이전트 초기화

    def simulate_timestep(self, current_time, reports):
        # 특정 시점 시뮬레이션

    def run_simulation(self, start_date, num_days):
        # 전체 시뮬레이션 실행
```

**핵심 기능**:
- 시간/요일별 활동 가중치 적용
- 에이전트 행동 결정
- 리포트 반응 시뮬레이션
- 이벤트 로깅 및 CSV 저장

---

#### 🔵 analyze_results.py
**역할**: 결과 분석 및 통계

**핵심 분석**:
- 기본 통계 (활동, 방문, 전환율)
- 시간대/요일/연령대별 분석
- 인기 매장 TOP 20
- 리포트 효과 분석
- 에이전트별 활동 통계
- 일별 트렌드

---

## 3. 데이터 흐름도

### 3.1 전체 데이터 흐름

```
┌─────────────┐
│ stores.csv  │
│ (매장 데이터) │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ load_and_index_stores│
│ (H3 인덱싱)          │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐     ┌──────────────┐
│  Environment        │     │ 인구_DB.json │
│  (공간 환경)         │◀────┤ (인구 통계)   │
└──────┬──────────────┘     └──────┬───────┘
       │                            │
       │                            ▼
       │                   ┌─────────────────┐
       │                   │PopulationStatistics│
       │                   │ (통계 분석)      │
       │                   └────────┬─────────┘
       │                            │
       │                            ▼
       │                   ┌─────────────────┐
       │                   │ AgentGenerator  │
       │                   │ (에이전트 생성)  │
       │                   └────────┬─────────┘
       │                            │
       │                            ▼
       │                   ┌─────────────────┐
       │                   │ agents.json     │
       │                   │ (20명 에이전트)  │
       │                   └────────┬─────────┘
       │                            │
       ├────────────────────────────┘
       │
       ▼
┌────────────────────────┐
│  SimulationEngine      │
│  (시뮬레이션 실행)       │
│                        │
│  • 시간 제어           │
│  • 활동 가중치 적용    │
│  • 에이전트 행동 결정  │
│  • 리포트 반응         │
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│  simulation_result.csv │
│  (840개 이벤트)         │
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│  analyze_results.py    │
│  (결과 분석)            │
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│  통계 및 인사이트       │
│  • 전환율             │
│  • 인기 매장          │
│  • 리포트 효과        │
└────────────────────────┘
```

### 3.2 실행 시퀀스

```
1. [초기화 단계]
   stores.csv 로드
   → H3 인덱싱 (Resolution 10)
   → Environment 객체 생성

2. [에이전트 생성 단계]
   인구_DB.json 로드
   → PopulationStatistics 분석
   → AgentGenerator로 20명 생성
   → agents.json 저장

3. [시뮬레이션 단계]
   for 7일:
       for 6회/일:
           for 20명 에이전트:
               1) 활동 여부 결정 (가중치 기반)
               2) 위치 생성 및 주변 매장 탐색
               3) 리포트 수신 (30% 확률)
               4) 방문 결정 (페르소나 기반)
               5) 이벤트 로깅

4. [분석 단계]
   simulation_result.csv 로드
   → 다차원 분석 수행
   → 통계 및 인사이트 출력
```

---

## 4. 에이전트 생성 과정

### 4.1 에이전트 페르소나 구조

```python
@dataclass
class AgentPersona:
    """에이전트의 페르소나 정보"""

    id: int                        # 고유 ID
    name: str                      # 이름 (랜덤 생성)
    age: int                       # 나이
    age_group: str                 # 연령대 (10대, 20대, ...)
    gender: str                    # 성별 (남성/여성)
    occupation: str                # 직업
    income_level: str              # 소득 수준 (상/중상/중/중하/하)
    value_preference: str          # 상권 이용 성향 (자연어)
    store_preferences: List[str]   # 선호 카테고리
    price_sensitivity: float       # 가격 민감도 (0~1)
    trend_sensitivity: float       # 트렌드 민감도 (0~1)
    quality_preference: float      # 품질 선호도 (0~1)
```

### 4.2 페르소나 생성 프로세스

```
┌─────────────────────┐
│  인구 통계 데이터    │
│                     │
│ • 연령별 분포       │
│   - 30대: 22.3%    │
│   - 20대: 19.1%    │
│   - 60대+: 18.6%   │
│                     │
│ • 성별 분포         │
│   - 여성: 56.1%    │
│   - 남성: 43.9%    │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  1단계: 기본 속성    │
│                     │
│  • 연령대 선택      │
│    (통계 기반 가중치) │
│  • 성별 선택        │
│    (통계 기반 가중치) │
│  • 나이 결정        │
│    (연령대 내 랜덤)  │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  2단계: 사회경제적   │
│                     │
│  • 직업 생성        │
│    (나이/성별 기반)  │
│  • 소득 수준        │
│    (나이/직업 기반)  │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  3단계: 선호도 생성  │
│                     │
│  • 상권 이용 성향   │
│    (나이/성별/소득)  │
│  • 선호 카테고리    │
│    (연령대/성별)     │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  4단계: 민감도 계산  │
│                     │
│  • 가격 민감도      │
│  • 트렌드 민감도    │
│  • 품질 선호도      │
│    (연령/소득 기반)  │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│   완성된 에이전트    │
│                     │
│  [예시]             │
│  이름: 김민서        │
│  나이: 27세 (20대)   │
│  직업: IT 개발자     │
│  소득: 중상          │
│  성향: 트렌디한 카페 │
│        SNS 핫플 선호 │
│  민감도:            │
│    - 가격: 0.5      │
│    - 트렌드: 0.8    │
│    - 품질: 0.6      │
└─────────────────────┘
```

### 4.3 페르소나별 특성 예시

| 연령대 | 성향 | 선호 카테고리 | 민감도 특징 |
|-------|------|--------------|------------|
| **20대 여성** | 트렌디한 카페, SNS 핫플 | 카페, 디저트, 브런치 | 트렌드↑ 가격↑ |
| **30대 직장인** | 시간 효율, 퀄리티 | 브런치, 한식, 일식 | 품질↑ 트렌드→ |
| **40대 가족** | 가족 단위, 익숙한 맛집 | 한식, 패밀리레스토랑 | 품질↑ 가격→ |
| **60대 이상** | 건강식, 저렴하고 푸짐한 | 한식, 국밥, 전통시장 | 가격↑↑ 트렌드↓ |

---

## 5. 환경 구축 (H3 공간 인덱싱)

### 5.1 H3 그리드 시스템 개요

**H3란?**
- Uber가 개발한 계층적 육각형 공간 인덱싱 시스템
- 전 세계를 육각형 격자로 분할
- Resolution 0~15 (15단계 해상도)

### 5.2 Resolution 10 선택 이유

```
┌────────────────────────────────────┐
│      H3 Resolution 비교             │
├────────────────────────────────────┤
│                                     │
│  Res 8:  506,508 m² (444.5m)      │
│          └─ 동네 단위 (너무 넓음)   │
│                                     │
│  Res 9:   72,360 m² (168.0m)      │
│          └─ 블록 단위              │
│                                     │
│  Res 10:  10,337 m² (63.5m) ⭐    │
│          └─ 상가 단위 (최적!)      │
│             • 도보 1-2분           │
│             • 인식 가능한 범위      │
│                                     │
│  Res 11:   1,477 m² (24.0m)       │
│          └─ 건물 단위 (너무 좁음)   │
│                                     │
│  Res 12:     211 m² (9.1m)        │
│          └─ 상세 위치              │
│                                     │
└────────────────────────────────────┘
```

**선택 기준**:
- ✅ 에이전트가 "주변"으로 인식할 수 있는 거리
- ✅ 도보로 1-2분 거리
- ✅ 상가 밀집 지역에 적합
- ✅ k_ring=1 시 약 127m 탐색 (7개 격자)

### 5.3 공간 인덱싱 프로세스

```
1. [매장 데이터 로드]
   stores.csv (756개 매장)
   ├─ 장소명
   ├─ x (경도)
   ├─ y (위도)
   ├─ 카테고리
   └─ 주소

2. [H3 인덱스 생성]
   for each 매장:
       lat, lng = 매장 좌표
       h3_index = h3.latlng_to_cell(lat, lng, resolution=10)
       매장['h3_index'] = h3_index

   결과: 86개 고유 격자에 756개 매장 배치

3. [인덱스 캐싱]
   h3_to_stores = {
       '8a30e1db1767fff': [매장1, 매장2, ...],
       '8a30e1db10cffff': [매장3, 매장4, ...],
       ...
   }

   ▶ O(1) 시간복잡도로 격자 내 매장 조회

4. [주변 매장 탐색]
   에이전트 위치(lat, lng) 입력
   │
   ├─ 현재 격자 계산
   │   current_h3 = h3.latlng_to_cell(lat, lng, 10)
   │
   ├─ 인접 격자 탐색 (k_ring=1)
   │   nearby_cells = h3.grid_disk(current_h3, 1)
   │   ▶ 7개 격자 (중심 1 + 주변 6)
   │
   └─ 매장 수집
       visible_stores = []
       for cell in nearby_cells:
           visible_stores += h3_to_stores[cell]
```

### 5.4 격자 배치 시각화 (개념도)

```
        ___     ___     ___
       /   \___/   \___/   \
       \ 0 /   \ 1 /   \ 2 /
        \_/ 🏪 \_/ 🏪 \_/
       /   \ 🏪/   \ 🏪/   \
       \ 3 /   \ 4 /   \ 5 /
        \_/ 🏪 \_/ 🏬 \_/
       /   \ 🏪/   \ 🏪/   \
       \ 6 /   \ 7 /   \ 8 /
        \_/     \_/     \_/
           ___     ___
          /   \___/   \

[격자 4가 현재 위치일 때]
k_ring=0: 격자 4만 (1개)
k_ring=1: 격자 0,1,3,4,5,7,8 (7개)
k_ring=2: 격자 0,1,2,3,4,5,6,7,8 + α (19개)

▶ k_ring=1 사용 = 도보 2-3분 범위
```

---

## 6. 시뮬레이션 실행 과정

### 6.1 시뮬레이션 설정

```python
# 기본 설정
START_DATE = 2025-02-03 (월요일)
NUM_DAYS = 7
TIME_INTERVALS_PER_DAY = 6
TOTAL_EVENTS = 20명 × 7일 × 6회 = 840개

# 시간대 구분
TIME_SLOTS = {
    '00-06': (0시~6시),   # 새벽
    '06-11': (6시~11시),  # 아침
    '11-14': (11시~14시), # 점심
    '14-17': (14시~17시), # 오후
    '17-21': (17시~21시), # 저녁
    '21-24': (21시~24시)  # 밤
}
```

### 6.2 단일 타임스텝 실행 과정

```
┌──────────────────────────────────────────┐
│  simulate_timestep(2025-02-03 06:00)    │
└──────────────────────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ For each 에이전트 (20명)│
        └───────────┬───────────┘
                    │
        ┌───────────▼───────────┐
        │ 1. 활동 여부 결정       │
        │                        │
        │  weekday = '월'        │
        │  time_slot = '06-11'   │
        │                        │
        │  weekday_weight = 0.135│
        │  time_weight = 0.196   │
        │  activity_prob = 0.66  │
        │                        │
        │  random() < 0.66?      │
        │  ├─ Yes → 활동        │
        │  └─ No → 비활동       │
        └───────────┬───────────┘
                    │
        ┌───────────▼───────────┐
        │ 2. 위치 및 관찰        │
        │    (활동 에이전트만)    │
        │                        │
        │  current_lat = 37.5552│
        │  current_lng = 126.908│
        │                        │
        │  visible_stores =      │
        │    env.get_visible_stores()│
        │  ▶ 주변 매장 67개 발견  │
        └───────────┬───────────┘
                    │
        ┌───────────▼───────────┐
        │ 3. 리포트 수신         │
        │    (30% 확률)          │
        │                        │
        │  random() < 0.3?       │
        │  └─ Yes: 리포트 선택   │
        │     "맥도날드 20% 할인"│
        └───────────┬───────────┘
                    │
        ┌───────────▼───────────┐
        │ 4. 방문 결정           │
        │                        │
        │  for each 매장:        │
        │      score = 평가점수  │
        │      ├─ 카테고리 매칭  │
        │      ├─ 리포트 반응    │
        │      └─ 페르소나 부합  │
        │                        │
        │  best_score > 0.5?     │
        │  ├─ Yes → visit        │
        │  └─ No → ignore        │
        └───────────┬───────────┘
                    │
        ┌───────────▼───────────┐
        │ 5. 이벤트 로깅         │
        │                        │
        │  SimulationEvent {     │
        │    timestamp,          │
        │    agent_name,         │
        │    age_group,          │
        │    decision,           │
        │    visited_store,      │
        │    ...                 │
        │  }                     │
        └───────────┬───────────┘
                    │
                    ▼
            [로그 누적 저장]
```

### 6.3 7일간 시뮬레이션 흐름

```
Day 1 (월요일)
├─ 06:00 ─ 20명 시뮬레이션 → 활동 20명, 방문 15명
├─ 10:00 ─ 20명 시뮬레이션 → 활동 20명, 방문 14명
├─ 14:00 ─ 20명 시뮬레이션 → 활동 18명, 방문 8명
├─ 18:00 ─ 20명 시뮬레이션 → 활동 20명, 방문 13명
├─ 22:00 ─ 20명 시뮬레이션 → 활동 17명, 방문 12명
└─ 02:00 ─ 20명 시뮬레이션 → 활동 20명, 방문 14명

Day 2 (화요일)
├─ ...
└─ ...

...

Day 7 (일요일)
├─ ...
└─ ...

총 결과:
- 전체 이벤트: 840개
- 활동 이벤트: 812개 (96.7%)
- 방문 이벤트: 524개 (62.4%)
```

---

## 7. 에이전트 인지-판단-행동 사이클

### 7.1 Stanford Generative Agents 기반 구조

본 시스템은 Stanford의 "Generative Agents" 논문에서 제시한 **인지 아키텍처**를 단순화하여 구현했습니다.

```
┌──────────────────────────────────────────────────┐
│         Generative Agents Architecture           │
├──────────────────────────────────────────────────┤
│                                                   │
│  [원본 논문의 3단계]                              │
│                                                   │
│  1. Memory Stream (기억 흐름)                     │
│     └─ 모든 경험을 시간순으로 저장                │
│                                                   │
│  2. Reflection (성찰)                             │
│     └─ 기억을 종합하여 고차원 통찰 생성            │
│                                                   │
│  3. Planning (계획)                               │
│     └─ 목표 기반 행동 계획 수립                   │
│                                                   │
├──────────────────────────────────────────────────┤
│                                                   │
│  [본 시스템의 구현]                               │
│                                                   │
│  ✅ Perception (인지)                             │
│     └─ H3 그리드 기반 주변 환경 관찰              │
│                                                   │
│  ✅ Decision (판단)                               │
│     └─ 페르소나 기반 방문 결정                    │
│                                                   │
│  ✅ Action (행동)                                 │
│     └─ 매장 방문 및 로깅                          │
│                                                   │
│  ⚠️  Memory/Reflection (미구현)                  │
│     └─ 향후 확장 가능                             │
│                                                   │
└──────────────────────────────────────────────────┘
```

### 7.2 에이전트 행동 사이클 (상세)

```
┌─────────────────────────────────────────────────────┐
│              에이전트 행동 사이클                     │
└─────────────────────────────────────────────────────┘

[1단계: PERCEPTION (인지)]
┌─────────────────────────────────────┐
│  환경 관찰 및 정보 수집              │
├─────────────────────────────────────┤
│                                     │
│  Input:                             │
│  • 현재 위치 (lat, lng)              │
│  • 현재 시간대                       │
│  • 현재 요일                         │
│                                     │
│  Process:                           │
│  1. H3 그리드 변환                   │
│     current_h3 = h3.latlng_to_cell()│
│                                     │
│  2. 주변 격자 탐색 (k_ring=1)        │
│     nearby_cells = h3.grid_disk()   │
│                                     │
│  3. 매장 수집                        │
│     visible_stores = []             │
│     for cell in nearby_cells:       │
│         visible_stores += stores[cell]│
│                                     │
│  Output:                            │
│  • 주변 매장 리스트 (DataFrame)       │
│  • 매장 정보 (이름, 카테고리, 위치)   │
│                                     │
└─────────────────────────────────────┘
            │
            ▼
[2단계: INFORMATION (정보 처리)]
┌─────────────────────────────────────┐
│  리포트 수신 및 처리                  │
├─────────────────────────────────────┤
│                                     │
│  Input:                             │
│  • 비즈니스 리포트 (30% 확률)         │
│                                     │
│  Report Structure:                  │
│  {                                  │
│    store_name: "맥도날드 망원점"     │
│    description: "빅맥 20% 할인"      │
│    target_age_groups: [20대, 30대]  │
│    appeal_factor: "price"           │
│    appeal_strength: 0.8             │
│  }                                  │
│                                     │
│  Process:                           │
│  • 타겟 연령대 확인                  │
│  • 어필 요소 파악                    │
│                                     │
└─────────────────────────────────────┘
            │
            ▼
[3단계: DECISION (판단)]
┌─────────────────────────────────────┐
│  페르소나 기반 의사결정               │
├─────────────────────────────────────┤
│                                     │
│  For each 매장:                      │
│                                     │
│  1. 기본 점수 (0.5)                  │
│                                     │
│  2. 카테고리 매칭 (+0.3)             │
│     if 매장_카테고리 in 선호_카테고리:│
│         score += 0.3                │
│                                     │
│  3. 리포트 반응 (최대 +0.5)          │
│     if 리포트_매장 == 현재_매장:     │
│         if 타겟_연령대_매칭:         │
│             score += 0.2            │
│                                     │
│         if appeal_factor == "price":│
│             score += price_sensitivity × 0.5│
│         if appeal_factor == "trend":│
│             score += trend_sensitivity × 0.5│
│         if appeal_factor == "quality":│
│             score += quality_preference × 0.5│
│                                     │
│  4. 랜덤 요소 (±0.1)                 │
│     score += random(-0.1, 0.1)      │
│                                     │
│  5. 최종 결정                        │
│     if max(scores) > 0.5:           │
│         decision = "visit"          │
│         visited_store = best_store  │
│     else:                           │
│         decision = "ignore"         │
│                                     │
└─────────────────────────────────────┘
            │
            ▼
[4단계: ACTION (행동)]
┌─────────────────────────────────────┐
│  행동 실행 및 기록                    │
├─────────────────────────────────────┤
│                                     │
│  Actions:                           │
│  • 매장 방문 (visit)                 │
│  • 무시 (ignore)                    │
│  • 비활동 (inactive)                 │
│                                     │
│  Event Logging:                     │
│  {                                  │
│    timestamp: "2025-02-03 06:00",  │
│    agent_name: "김민서",            │
│    age_group: "20대",               │
│    decision: "visit",               │
│    visited_store: "카페공명",        │
│    decision_reason: "리포트 반응"    │
│  }                                  │
│                                     │
│  Output:                            │
│  • simulation_result.csv 저장       │
│  • visit_log.csv 저장 (방문만)       │
│                                     │
└─────────────────────────────────────┘
```

### 7.3 의사결정 예시

#### 예시 1: 20대 여성, 트렌드 리포트

```python
# 에이전트
agent = {
    name: "김민서",
    age: 27,
    age_group: "20대",
    gender: "여성",
    occupation: "디자이너",
    store_preferences: ["카페", "디저트카페", "브런치"],
    price_sensitivity: 0.5,
    trend_sensitivity: 0.8,  # 높음
    quality_preference: 0.6
}

# 주변 매장
stores = [
    {name: "스타벅스", category: "카페"},
    {name: "몬스터스토리지", category: "카페 > 디저트"},
    {name: "맥도날드", category: "패스트푸드"}
]

# 리포트
report = {
    store_name: "몬스터스토리지",
    description: "신메뉴 '딸기 크로플' 출시",
    target_age_groups: ["20대", "30대"],
    appeal_factor: "trend",
    appeal_strength: 0.9
}

# 의사결정 과정
스타벅스:
  기본 점수: 0.5
  + 카테고리 매칭: 0.3 (카페 선호)
  = 0.8

몬스터스토리지:
  기본 점수: 0.5
  + 카테고리 매칭: 0.3 (카페 선호)
  + 타겟 연령: 0.2 (20대 매칭)
  + 트렌드 어필: 0.8 × 0.9 × 0.5 = 0.36
  = 1.36 → 최고 점수!

맥도날드:
  기본 점수: 0.5
  = 0.5

▶ 결정: 몬스터스토리지 방문
▶ 이유: "리포트 '신메뉴 딸기 크로플'에 반응"
```

#### 예시 2: 60대 남성, 가격 할인 리포트

```python
# 에이전트
agent = {
    name: "박철수",
    age: 68,
    age_group: "60대+",
    gender: "남성",
    occupation: "은퇴자",
    store_preferences: ["한식", "국밥", "칼국수"],
    price_sensitivity: 0.8,  # 높음
    trend_sensitivity: 0.1,  # 낮음
    quality_preference: 0.5
}

# 리포트
report = {
    store_name: "맥도날드",
    description: "빅맥 세트 20% 할인",
    target_age_groups: ["10대", "20대", "30대"],
    appeal_factor: "price",
    appeal_strength: 0.8
}

# 의사결정
맥도날드:
  기본 점수: 0.5
  + 카테고리 매칭: 0 (패스트푸드 선호 안함)
  + 타겟 연령: 0 (60대 미포함)
  + 가격 어필: 0.8 × 0.8 × 0.5 = 0.32
  = 0.82

망원시장손칼국수:
  기본 점수: 0.5
  + 카테고리 매칭: 0.3 (칼국수 선호)
  = 0.8

▶ 결정: 맥도날드 방문 (근소한 차이로)
▶ 이유: "가격 할인 리포트 효과"
▶ 의외의 결과: 타겟 아니었지만 가격 민감도로 방문!
```

---

## 8. 시간/요일별 활동 가중치 시스템

### 8.1 실제 유동인구 데이터

```
┌────────────────────────────────────┐
│      요일별 유동인구 분포           │
├────────────────────────────────────┤
│                                     │
│  일요일: 15.7% ████████████████    │
│  토요일: 15.6% ███████████████     │
│  금요일: 13.9% ██████████████      │
│  수요일: 13.9% ██████████████      │
│  목요일: 13.8% ██████████████      │
│  화요일: 13.6% █████████████       │
│  월요일: 13.5% █████████████       │
│                                     │
│  ▶ 주말이 평일보다 약 14% 더 많음   │
│                                     │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│      시간대별 유동인구 분포         │
├────────────────────────────────────┤
│                                     │
│  00-06: 28.8% ████████████████████ │
│  06-11: 19.6% █████████████        │
│  17-21: 16.3% ██████████           │
│  21-24: 13.7% ████████             │
│  14-17: 11.1% ██████               │
│  11-14: 10.5% █████                │
│                                     │
│  ▶ 새벽/아침이 가장 활발            │
│  ▶ 점심 시간대가 가장 낮음          │
│                                     │
└────────────────────────────────────┘
```

### 8.2 활동 확률 계산 메커니즘

```python
def _should_agent_be_active(weekday, time_slot):
    """
    에이전트 활동 여부 결정
    """
    # 1. 통계에서 가중치 가져오기
    weekday_weight = stats.get_weekday_weight(weekday)
    # 예: 월요일 = 0.135

    time_weight = stats.get_time_weight(time_slot)
    # 예: 06-11 = 0.196

    # 2. 결합 가중치 계산
    combined_weight = (weekday_weight + time_weight) / 2
    # 예: (0.135 + 0.196) / 2 = 0.1655

    # 3. 활동 확률로 변환 (스케일링)
    activity_prob = combined_weight * 7
    # 예: 0.1655 * 7 = 1.158

    # 4. 확률 기반 결정
    return random.random() < activity_prob
    # 예: random() = 0.32 < 1.158 → True (활동)
```

### 8.3 시간/요일 조합별 활동률

```
┌─────────────────────────────────────────────────────┐
│         시간대 × 요일 활동 매트릭스                    │
├─────────────────────────────────────────────────────┤
│                                                      │
│           월    화    수    목    금    토    일      │
│  00-06   96%   97%   98%   97%   98%   99%   99%   │
│  06-11   100%  100%  100%  100%  100%  100%  100%  │
│  11-14   92%   93%   94%   93%   94%   95%   95%   │
│  14-17   90%   91%   92%   91%   92%   93%   93%   │
│  17-21   94%   95%   96%   95%   96%   97%   97%   │
│  21-24   93%   94%   95%   94%   95%   96%   96%   │
│                                                      │
│  💡 인사이트:                                         │
│  • 아침(06-11)이 가장 활발 (거의 100%)                │
│  • 점심/오후 시간대가 상대적으로 낮음                  │
│  • 주말이 평일보다 전반적으로 높음                     │
│                                                      │
└─────────────────────────────────────────────────────┘
```

### 8.4 실제 시뮬레이션 결과와 비교

```
[예상] 요일별 활동 비율 (통계 기반)
일: 15.7% > 토: 15.6% > 금: 13.9% > 수: 13.9% > ...

[실제] 시뮬레이션 요일별 활동
수: 118회 > 일: 118회 > 토: 117회 > 월: 115회 > ...

▶ 통계적 경향성은 유지하되, 랜덤성으로 인해 미세한 변동
▶ 샘플 수가 작아(20명) 확률적 변동 존재
```

---

## 9. 비즈니스 리포트 반응 메커니즘

### 9.1 리포트 구조

```python
@dataclass
class BusinessReport:
    """비즈니스 리포트"""

    store_name: str          # 대상 매장
    report_type: str         # 리포트 유형
    description: str         # 설명
    target_age_groups: List  # 타겟 연령대
    appeal_factor: str       # 어필 요소
    appeal_strength: float   # 어필 강도 (0~1)
```

### 9.2 리포트 유형별 전략

```
┌─────────────────────────────────────────────────┐
│          리포트 유형 및 전략                      │
├─────────────────────────────────────────────────┤
│                                                  │
│  1. PRICE (가격 소구)                            │
│     ├─ 할인/프로모션/이벤트                       │
│     ├─ 타겟: 가격 민감도 높은 층                  │
│     └─ 예: "빅맥 세트 20% 할인"                  │
│                                                  │
│  2. TREND (트렌드 소구)                          │
│     ├─ 신메뉴/화제/SNS 핫플                      │
│     ├─ 타겟: 트렌드 민감도 높은 층                │
│     └─ 예: "인스타그램 화제! 딸기 크로플"         │
│                                                  │
│  3. QUALITY (품질 소구)                          │
│     ├─ 전통/장인/특별 서비스                      │
│     ├─ 타겟: 품질 선호도 높은 층                  │
│     └─ 예: "개업 20주년 기념 특별 서비스"         │
│                                                  │
│  4. RENOVATION (리뉴얼 소구)                     │
│     ├─ 새 단장/확장/시설 개선                     │
│     ├─ 타겟: 전 연령대                           │
│     └─ 예: "새로운 모습으로 재오픈"               │
│                                                  │
│  5. EVENT (이벤트 소구)                          │
│     ├─ 특별 행사/기념일/축제                      │
│     ├─ 타겟: 특정 관심사                         │
│     └─ 예: "망원동 음식 축제 참여"                │
│                                                  │
└─────────────────────────────────────────────────┘
```

### 9.3 리포트 효과 계산 과정

```
[리포트]
매장: 맥도날드 망원점
설명: 빅맥 세트 20% 할인 이벤트
타겟: [10대, 20대, 30대]
어필: price
강도: 0.8

[에이전트: 김민서 (27세, 20대, 여성)]
가격 민감도: 0.5
트렌드 민감도: 0.8
품질 선호도: 0.6

┌────────────────────────────────────┐
│       리포트 효과 계산              │
├────────────────────────────────────┤
│                                     │
│  1. 기본 점수                       │
│     score = 0.5                    │
│                                     │
│  2. 타겟 연령대 체크                │
│     20대 in [10대, 20대, 30대]?    │
│     ✅ Yes                          │
│     score += 0.2                   │
│     score = 0.7                    │
│                                     │
│  3. 어필 요소 계산                  │
│     appeal_factor = "price"        │
│     agent.price_sensitivity = 0.5  │
│     appeal_strength = 0.8          │
│                                     │
│     bonus = 0.5 × 0.8 × 0.5        │
│           = 0.2                    │
│     score += 0.2                   │
│     score = 0.9                    │
│                                     │
│  4. 최종 점수                       │
│     score = 0.9                    │
│     threshold = 0.5                │
│     0.9 > 0.5? ✅ Yes              │
│                                     │
│  ▶ 결과: 방문 결정                  │
│                                     │
└────────────────────────────────────┘
```

### 9.4 실제 리포트 효과 분석 결과

```
┌─────────────────────────────────────────────────┐
│          시뮬레이션 리포트 효과 분석              │
├─────────────────────────────────────────────────┤
│                                                  │
│  📄 리포트 1: 맥도날드 20% 할인 (가격 소구)       │
│     수신: 92회                                   │
│     방문: 57회                                   │
│     효과율: 62.0%                                │
│     연령대별 반응:                                │
│       • 20대: 77.8% 🔥                          │
│       • 30대: 75.0%                             │
│       • 60대+: 71.9%                            │
│                                                  │
│  📄 리포트 2: 몬스터스토리지 딸기 크로플 (트렌드) │
│     수신: 69회                                   │
│     방문: 45회                                   │
│     효과율: 65.2%                                │
│     연령대별 반응:                                │
│       • 50대: 85.7% 🔥 (의외!)                  │
│       • 30대: 75.0%                             │
│       • 60대+: 65.2%                            │
│                                                  │
│  📄 리포트 3: 망원시장손칼국수 20주년 (품질)      │
│     수신: 67회                                   │
│     방문: 42회                                   │
│     효과율: 62.7%                                │
│     연령대별 반응:                                │
│       • 20대: 87.5% 🔥                          │
│       • 30대: 75.0%                             │
│       • 10대: 70.0%                             │
│                                                  │
│  💡 인사이트:                                     │
│  • 모든 리포트가 60% 이상의 효과                  │
│  • 타겟 연령대 외에도 반응 있음                   │
│  • 의외의 조합 발견 (50대 × 트렌드)              │
│                                                  │
└─────────────────────────────────────────────────┘
```

---

## 10. 결과 분석 및 시각화

### 10.1 분석 모듈 구조

```
analyze_results.py
│
├─ [1] 기본 통계
│   ├─ 전체/활동/방문 이벤트 수
│   └─ 방문 전환율 계산
│
├─ [2] 시간대별 분석
│   ├─ 시간대별 활동 수
│   ├─ 시간대별 방문 수
│   └─ 시간대별 전환율
│
├─ [3] 요일별 분석
│   ├─ 요일별 활동 패턴
│   └─ 요일별 전환율
│
├─ [4] 연령대별 분석
│   ├─ 연령대별 활동 수
│   └─ 연령대별 방문 성향
│
├─ [5] 인기 매장 TOP 20
│   └─ 방문 횟수 순위
│
├─ [6] 카테고리별 분석
│   └─ 카테고리별 선호도
│
├─ [7] 리포트 효과 분석
│   ├─ 전체 효과율
│   ├─ 리포트별 세부 효과
│   └─ 연령대별 반응률
│
├─ [8] 에이전트별 통계
│   ├─ 에이전트별 활동/방문
│   └─ 에이전트별 전환율
│
├─ [9] 일별 트렌드
│   └─ 일별 활동/방문 변화
│
└─ [10] 종합 인사이트
    └─ 핵심 발견 사항
```

### 10.2 핵심 지표 요약

```
┌─────────────────────────────────────────────────┐
│              시뮬레이션 결과 요약                 │
├─────────────────────────────────────────────────┤
│                                                  │
│  📊 전체 통계                                     │
│  ├─ 총 이벤트: 840개                            │
│  ├─ 활동 이벤트: 812개 (96.7%)                  │
│  ├─ 방문 이벤트: 524개 (62.4%)                  │
│  └─ 방문 전환율: 64.5%                          │
│                                                  │
│  ⏰ 최고 성과 시간대                              │
│  ├─ 활동: 06-11 (280회)                        │
│  ├─ 방문: 06-11 (189회)                        │
│  └─ 전환율: 06-11 (67.5%)                      │
│                                                  │
│  📅 최고 성과 요일                                │
│  ├─ 활동: 수요일 (118회)                        │
│  ├─ 방문: 화요일 (80회)                         │
│  └─ 전환율: 화요일 (69.6%)                      │
│                                                  │
│  👥 연령대별 특성                                 │
│  ├─ 최다 활동: 60대+ (284회)                    │
│  ├─ 최다 방문: 60대+ (186회)                    │
│  └─ 최고 전환율: 20대 (75.9%)                   │
│                                                  │
│  🏪 TOP 3 인기 매장                              │
│  ├─ 1위: 돌쇠풍천민물장어 망원점 (9회)           │
│  ├─ 2위: 지리산김치찌개 (9회)                    │
│  └─ 3위: 일번지대박집 (8회)                      │
│                                                  │
│  📄 리포트 효과                                   │
│  ├─ 리포트 수신: 228회                          │
│  ├─ 리포트 후 방문: 144회                       │
│  └─ 리포트 반응률: 63.2%                        │
│                                                  │
└─────────────────────────────────────────────────┘
```

### 10.3 데이터 출력 형식

#### simulation_result.csv
```csv
timestamp,agent_id,agent_name,age_group,gender,weekday,time_slot,is_active,current_lat,current_lng,visible_stores_count,report_received,decision,decision_reason,visited_store,visited_category
2025-02-03 06:00,1,송민서,60대+,여성,월,06-11,True,37.550627,126.909160,0,,ignore,주변에 매장이 없음,,
2025-02-03 06:00,2,안민지,10대,여성,월,06-11,True,37.556199,126.908855,121,,visit,선호 카테고리 및 페르소나 부합,나고미칸,음식점 > 일식
...
```

#### visit_log.csv (방문만 필터링)
```csv
timestamp,agent_name,age_group,gender,weekday,time_slot,visited_store,visited_category,report_received,decision_reason
2025-02-03 06:00,안민지,10대,여성,월,06-11,나고미칸,음식점 > 일식,,선호 카테고리 및 페르소나 부합
2025-02-03 06:00,홍소율,50대,여성,월,06-11,장모님멸치국수,음식점 > 한식 > 국수,맥도날드 망원점: 빅맥 세트 20% 할인 이벤트,선호 카테고리 및 페르소나 부합
...
```

---

## 11. 확장 가능성

### 11.1 향후 추가 가능 기능

```
┌─────────────────────────────────────────────────┐
│           확장 로드맵                            │
├─────────────────────────────────────────────────┤
│                                                  │
│  Phase 1: 기본 구현 ✅ (현재)                     │
│  ├─ H3 공간 인덱싱                               │
│  ├─ 인구 통계 기반 에이전트                       │
│  ├─ 시간/요일별 가중치                            │
│  └─ 리포트 반응 시뮬레이션                        │
│                                                  │
│  Phase 2: 메모리 시스템 🔜                        │
│  ├─ Memory Stream 구현                          │
│  │   └─ 방문 기록 저장                           │
│  ├─ 선호도 학습                                  │
│  │   └─ 방문 패턴 분석                           │
│  └─ 단골 형성 메커니즘                            │
│      └─ 재방문율 추적                            │
│                                                  │
│  Phase 3: 성찰(Reflection) 🔜                    │
│  ├─ 경험 기반 통찰 생성                          │
│  ├─ 선호도 업데이트                              │
│  └─ 개인화된 의사결정                            │
│                                                  │
│  Phase 4: 계획(Planning) 🔜                      │
│  ├─ 목적지 기반 이동                             │
│  ├─ 경로 최적화                                  │
│  └─ 일정 계획 수립                               │
│                                                  │
│  Phase 5: LLM 통합 🔮                            │
│  ├─ GPT/Claude 기반 의사결정                    │
│  ├─ 자연어 리포트 생성                           │
│  └─ 대화형 에이전트                              │
│                                                  │
│  Phase 6: 시각화 🔮                              │
│  ├─ 웹 대시보드 (Streamlit)                     │
│  ├─ 지도 시각화 (Folium)                        │
│  └─ 실시간 모니터링                              │
│                                                  │
└─────────────────────────────────────────────────┘
```

### 11.2 코드 확장 포인트

```python
# 1. Memory Stream 추가
class AgentMemory:
    """에이전트 기억 시스템"""

    def __init__(self):
        self.visit_history = []
        self.preferences = {}

    def add_visit(self, store, satisfaction):
        """방문 기록 추가"""

    def get_favorite_stores(self):
        """단골 매장 추출"""

    def update_preferences(self):
        """선호도 업데이트"""

# 2. Reflection 추가
class AgentReflection:
    """에이전트 성찰 시스템"""

    def analyze_patterns(self, memory):
        """패턴 분석"""

    def generate_insights(self):
        """통찰 생성"""

# 3. Planning 추가
class AgentPlanning:
    """에이전트 계획 시스템"""

    def create_daily_plan(self):
        """일일 계획 수립"""

    def optimize_route(self, destinations):
        """경로 최적화"""

# 4. LLM 통합
def llm_based_decision(agent, context, report):
    """LLM 기반 의사결정"""

    prompt = f"""
    에이전트 정보: {agent.to_dict()}
    상황: {context}
    리포트: {report}

    이 에이전트는 방문할까요? 이유는?
    """

    response = openai.chat.completions.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content
```

---

## 12. 참고 자료

### 12.1 핵심 논문

1. **Generative Agents: Interactive Simulacra of Human Behavior**
   - 저자: Park et al., Stanford University
   - 링크: https://arxiv.org/abs/2304.03442
   - 핵심: Memory, Reflection, Planning 아키텍처

2. **H3: Uber's Hexagonal Hierarchical Spatial Index**
   - Uber Engineering
   - 링크: https://h3geo.org/
   - 핵심: 육각형 공간 인덱싱 시스템

### 12.2 기술 문서

- H3-Py Documentation: https://github.com/uber/h3-py
- Pandas Documentation: https://pandas.pydata.org/
- Python Dataclasses: https://docs.python.org/3/library/dataclasses.html

### 12.3 프로젝트 관련 문서

- README.md: 프로젝트 개요 및 실행 방법
- DOCUMENTATION.md: 기술 문서 (이 파일)
- requirements.txt: 필수 라이브러리

---

## 📝 변경 이력

| 날짜 | 버전 | 변경 내용 |
|-----|------|----------|
| 2025-02-02 | 1.0.0 | 초기 버전 구현 완료 |

---

**작성**: Claude Sonnet 4.5
**날짜**: 2025-02-02
**프로젝트**: Mangwon-sim (망원동 상권 에이전트 시뮬레이션)
