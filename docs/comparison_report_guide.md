# 비교 분석 보고서 지표 설계 가이드

> `generate_comparison_report.py` — `ComparisonReportGenerator` 클래스
> 전략 적용 전(Sim 1) vs 후(Sim 2) ABM 시뮬레이션 비교 보고서

---

## 데이터 흐름 개요

```
visit_log.csv (Sim1 / Sim2)
    │
    ├─ _load_sim_data()
    │     ├─ persona_type 파생  (segment 컬럼 파싱)
    │     ├─ 평점 컬럼 숫자 변환
    │     └─ timestamp → hour 파싱
    │
    ├─ analysis 1~7 실행
    │     └─ 결과를 metrics_summary dict에 캐시
    │
    ├─ analysis_8 (LLM 요약)
    │     └─ metrics_summary → 구조화 프롬프트 → GPT-4o-mini
    │
    └─ _write_markdown_report()
          └─ Comparison_Report.md + reports/figures/*.png
```

**데이터 소스**

| 파일 | 설명 |
|------|------|
| `{dir}/visit_log.csv` | 방문 기록 메인 데이터 |
| `{dir}/simulation_result.csv` | visit_log 없을 때 fallback (decision=visit 필터) |
| `{dir}/store_ratings.json` | 매장 메타 정보 (평균 가격 등) |
| `{dir}/agents_final.json` | 에이전트 최종 상태 |

---

## 지표 1 — 기본 방문 지표 (Overview) + 워드클라우드

### 설계 의도

> "전략 후 손님이 실제로 늘었는가? 방문 이유가 달라졌는가?"

- **방문 수**는 절대값이라 단독으로 보면 오해가 생길 수 있음
- **시장 점유율**(`타겟 방문 / 전체 방문 × 100`)로 보완 → 경쟁 매장도 함께 성장했다면 점유율은 그대로
- **워드클라우드**는 `reason` + `visited_category` 텍스트 합산 → 방문 동기가 전략 전/후에 어떻게 바뀌었는지 정성적으로 확인

### 출력 예시

```
방문 키워드 워드클라우드 비교

[Sim 1 — 전략 전]               [Sim 2 — 전략 후]
   가격대비          맛            분위기      맛
      혼밥     직장인             모임    가성비
  점심특선   메뉴         이벤트    직장인
     편의성               특선메뉴      혼밥
```

**보고서 테이블:**

| 지표 | Sim 1 (전략 전) | Sim 2 (전략 후) | 변화 |
|------|:--------------:|:--------------:|:----:|
| 총 방문 수 | 142건 | 189건 | **+33.1%** |
| 시장 점유율 | 8.20% | 10.45% | +2.25%p |

---

## 지표 2 — 평점 분포 분석 (Rating Spread)

### 설계 의도

> "평균이 오른 게 아니라 분포 자체가 바뀌었는가?"

- **KDE(커널 밀도 추정)** 선택 이유: 에이전트 수가 적을 때 히스토그램은 불연속적으로 튐 → KDE로 연속 분포 형태(단봉/쌍봉, 꼬리 두께)를 관찰
- **맛/가성비/분위기 3개 분리**: 전략 유형에 따라 오르는 항목이 다름 (예: 가격 할인 전략은 가성비만 오름)
- **만족도 막대**(`≥ 4점 비율`): 평균이 같아도 4점 이상 비율이 다르면 의미가 다름

### 출력 예시

```
[맛 평점 KDE]        [가성비 평점 KDE]     [분위기 평점 KDE]
밀도                 밀도                  밀도
│  ╭─╮ Sim1         │    ╭──╮ Sim1        │  ╭──╮ Sim1
│ ╭╯  ╰╮ Sim2       │  ╭─╯  ╰─╮ Sim2     │  │   │ Sim2
│╭╯    ╰╮           │ ╭╯      ╰╮          │╭─╯   ╰─╮
└───────────점수    └────────────점수     └──────────점수
  1  2  3  4  5       1  2  3  4  5        1  2  3  4  5
```

**보고서 테이블:**

| 지표 | Sim 1 (전략 전) | Sim 2 (전략 후) | 변화 |
|------|:--------------:|:--------------:|:----:|
| 평균 종합 평점 | 3.42점 | 3.81점 | **+0.39** |
| 만족도 (4점 이상) | 31.0% | 54.5% | +23.5%p |

---

## 지표 3 — 시간대별 손님 변화 (Hourly Traffic)

### 설계 의도

> "전략이 특정 시간대에만 효과가 있는가? 피크타임이 바뀌었는가?"

- 4개 타임슬롯(아침 07 / 점심 12 / 저녁 18 / 야식 22)을 **꺾은선 그래프**로 시계열처럼 표현
- 두 선 사이 면적을 보라색으로 채워 **격차**를 직관적으로 강조
- 피크 슬롯 변화는 `metrics_summary`에 저장 → LLM 요약에 자동 전달

### 출력 예시

```
[시간대별 방문 트래픽 변화]

방문횟수
45 │          ●── Sim2 (전략 후)
40 │         ╱  \
35 │        ○    \── Sim1 (전략 전)
30 │       ╱      \  ●
25 │      ╱        ○╱  \
20 │  ○──○                \
15 │                       ○──●
   └──────────────────────────────
     아침(07) 점심(12) 저녁(18) 야식(22)
```

**보고서 테이블:**

| 지표 | Sim 1 | Sim 2 |
|------|:-----:|:-----:|
| 피크 타임슬롯 | 점심(12) | 저녁(18) |

---

## 지표 4 — 세대별 증감 분석 (Generation Impact)

### 설계 의도

> "어떤 세대가 새로 들어오고, 어떤 세대가 빠졌는가?"

- 5개 세대(`Z1, Z2, Y, X, S`)를 **방문 비율**로 비교 (절대값 아닌 비율 — 시뮬레이션 규모 차이 보정)
- 각 막대 위에 **±%p 변화량**을 초록(증가)/빨강(감소)으로 표시 → 어느 세대를 공략할지 직접 보임

### 세대 정의

| 코드 | 세대 | 대략적 특성 |
|:----:|------|------------|
| Z1 | Z세대 전기 (10대) | SNS 영향 강함, 트렌드 민감 |
| Z2 | Z세대 후기 (20대 초반) | 가성비·경험 중시 |
| Y | 밀레니얼 (20대 후반~30대) | 직장인 점심 수요 높음 |
| X | X세대 (40대) | 가족 모임, 안정 선호 |
| S | 시니어 (50대+) | 분위기·서비스 중시 |

### 출력 예시

```
[세대별 방문 비율 변화]

비율(%)
35 │    +8.2%p
30 │  ■ ■
25 │  ■ ■         -3.1%p
20 │  ■ ■   □ □    □ ■    ■ □   □ □
15 │  ■ ■   □ □    □ ■    ■ □   □ □
10 │  ■ ■   □ □    □ ■    ■ □   □ □
   └────────────────────────────────
     Z1     Z2      Y      X      S
   □ Sim1(전략전)  ■ Sim2(전략후)
```

**보고서 테이블:**

| 세대 | Sim 1 (전략 전) | Sim 2 (전략 후) | 변화 |
|:----:|:--------------:|:--------------:|:----:|
| Z1 | 12.0% | 20.2% | **+8.2%p** |
| Z2 | 18.5% | 22.1% | +3.6%p |
| Y | 31.2% | 28.1% | -3.1%p |
| X | 25.0% | 20.8% | -4.2%p |
| S | 13.3% | 8.8% | -4.5%p |

---

## 지표 5 — 방문 목적별 상세 분석 (Purpose Analysis) ⭐

### 설계 의도

> "이 매장에 오는 사람의 유형이 바뀌었는가? 유형별 만족도는 어떤가?"

`segment` 컬럼(`"유동_생활베이스형_1인"`)에서 4가지 목적 유형 추출:

| 유형 | 설명 | 주요 특성 |
|------|------|----------|
| 생활베이스형 | 혼자 일상적으로 자주 오는 고객 | 재방문율 높음, 혼밥 |
| 사적모임형 | 친구/연인과 오는 고객 | 분위기·맛 중시 |
| 공적모임형 | 업무/미팅 목적 고객 | 서비스·환경 중시 |
| 가족모임형 | 가족 단위 고객 | 메뉴 다양성·가성비 중시 |

**추출 로직:**
```python
def _extract_persona_type(segment: str) -> str:
    # "유동_생활베이스형_1인" → "생활베이스형"
    for kw in ["생활베이스형", "사적모임형", "공적모임형", "가족모임형"]:
        if kw in segment:
            return kw
    return "기타"
```

**5-1 구상: 100% Stacked Bar**
- 비중의 합이 100%가 되도록 쌓음 → 매장 **성격 변화**를 구성 비율로 파악
- 예: 생활베이스형이 60%→35%로 줄고 사적모임형이 15%→40%로 늘면 → 혼밥집에서 모임집으로 성격 전환

**5-2 구상: 유형별 만족도 그룹 바 차트**
- 유형별로 만족도가 어떻게 다른지 교차 분석
- "사적모임형은 많이 오는데 만족도가 낮다" → 분위기/서비스 개선 시그널

### 출력 예시

```
[방문 목적 유형 비중 변화]           [방문 목적 유형별 평균 만족도]

100% ┤가족모임  12%│11%            5.0 ┤
     ├공적모임  10%│14%            4.0 ┤ ─ ─ ─ ─ ─ ─ (만족 기준 4.0)
     ├사적모임  15%│40%            3.0 ┤
 0%  ├생활베이스60%│35%            2.0 ┤
     └──────────────               1.0 ┤
      Sim1  Sim2                       └────────────────────
                                        생활  사적  공적  가족
```

**보고서 테이블:**

| 방문 목적 | 비중(전) | 비중(후) | 비중 변화 | 만족도(전) | 만족도(후) |
|:--------:|:-------:|:-------:|:--------:|:---------:|:---------:|
| 생활베이스형 | 60.2% | 35.1% | -25.1%p | 3.45 | 3.62 |
| 사적모임형 | 15.3% | 40.2% | **+24.9%p** | 3.20 | 3.95 |
| 공적모임형 | 10.1% | 14.3% | +4.2%p | 3.10 | 3.40 |
| 가족모임형 | 14.4% | 10.4% | -4.0%p | 3.55 | 3.70 |

---

## 지표 6 — 재방문율 분석 (Retention)

### 설계 의도

> "새로 왔다가 떠나는 구조인가, 단골이 쌓이는 구조인가?"

`agent_id` 집합 연산으로 계산:

```
retained  = Sim1 방문자 ∩ Sim2 방문자   → 기존 고객 유지
new_users = Sim2 방문자 - Sim1 방문자   → 신규 유입
churned   = Sim1 방문자 - Sim2 방문자   → 이탈
```

- **파이 차트**: Sim2 방문자 중 재방문/신규 구성비 → 성장 방식 파악
- **바 차트**: 이탈/유지/신규 절대 인원 → "신규가 이탈보다 많은가" 직관적 비교

### 출력 예시

```
[Sim2 방문자 구성]            [고객 이탈/유지/신규 현황]

     ╭─────╮                 명수
    ╱ 신규  ╲                30 │  30
   │  42%   │                  │      ■ 25
   │        │                  │           ■ 18
    ╲ 재방문╱                  └──────────────
     ╰─────╯                   이탈  유지  신규
      58%
```

**보고서 테이블:**

| 지표 | 수치 |
|------|:----:|
| Sim 1 방문 에이전트 수 | 43명 |
| Sim 2 방문 에이전트 수 | 43명 |
| 재방문 (기존 고객 유지) | 25명 |
| 신규 유입 | 18명 |
| 이탈 (Churn) | 30명 |
| **기존 고객 유지율** | **45.5%** |
| Sim2 신규 고객 비율 | 41.9% |

---

## 지표 7 — 경쟁 매장 비교 (Radar Chart)

### 설계 의도

> "전략 후 타겟 매장이 경쟁 매장 대비 어떤 포지션인가?"

- Sim2 기준 방문수 **TOP 5 매장** 선정 (타겟 매장은 순위 무관 강제 포함)
- 4개 지표를 **0~100 정규화** 후 레이더 축으로 사용
  - 정규화 이유: 단위가 다른 지표(방문수 수십 ↔ 평점 1~5)를 한 그래프에 표시

**레이더 4개 축:**

| 축 | 계산 방법 | 의미 |
|----|----------|------|
| 방문수 | `len(grp)` | 절대적 인기 |
| 평균평점 | 맛/가성비/분위기 평균 | 고객 만족도 |
| 재방문율 | `동일 agent_id 2회 이상 비율` | 충성도 |
| 리뷰수 | 방문 건수 (review_count) | 구전 효과 가능성 |

- 타겟 매장은 **선 두께 3배 + 채우기 강조** → 경쟁 구도 내 위치 파악

### 출력 예시

```
         방문수
          100
           │
    재방문율──┼──평균평점
           │
         리뷰수

★ 돼지야  ─── 크게 그려짐 (강조)
  경쟁A   --- 얇은 선
  경쟁B   ... 얇은 선
```

**보고서 테이블:**

| 지표 | Sim 1 (타겟) | Sim 2 (타겟) |
|------|:-----------:|:-----------:|
| 방문수 | 142건 | 189건 |
| 평균 평점 | 3.42 | 3.81 |
| 재방문율 | 28.0% | 35.0% |

---

## 지표 8 — 종합 평가 (LLM Summary)

### 설계 의도

> "앞 7개 수치를 사람이 읽을 수 있는 인사이트 문장으로 변환"

- 1~7번 결과를 `metrics_summary` dict에 캐시 → 구조화 프롬프트로 GPT-4o-mini에 전달
- **요청 3가지**: ① 전략 효과 ② 바뀐 주 고객층 특성 ③ 향후 권장 사항
- **규칙 기반 fallback**: API 키 없을 때도 동일 구조의 한국어 텍스트 자동 생성

**LLM 입력 프롬프트 구조:**

```
## 핵심 지표 요약

### 방문 지표
- 방문 수: 142건 → 189건 (+33.1%)
- 시장 점유율: 8.2% → 10.5%

### 평점 및 만족도
- 평균 평점: 3.42 → 3.81
- 만족도(4점 이상 비율): 31.0% → 54.5%

### 세대별 방문 비율 변화
- Z1: 12.0% → 20.2% (+8.2%p)
- ...

### 방문 목적 유형별 비중·만족도 변화
- 생활베이스형: 비중 60.2%→35.1% (-25.1%p) | 만족도 3.45→3.62
- ...

### 재방문율
- 기존 고객 유지율: 45.5%
- 신규 유입: 18명
- 이탈: 30명
```

### 출력 예시 (규칙 기반 fallback)

---

**전략의 효과 분석**

전략 적용 후 '돼지야'의 방문 수는 +33.1%로 증가하였습니다. 평균 평점은 3.42점에서 3.81점으로(+0.39) 변화했으며, 4점 이상 만족도 비율은 31.0%에서 54.5%로 +23.5%p 개선되었습니다. 전략이 방문 지표에 전반적으로 긍정적인 영향을 미쳤습니다.

**바뀐 주 고객층의 특성**

세대 분포에서 Z1 세대의 비율이 +8.2%p로 가장 크게 증가하였고, S 세대는 -4.5%p 감소하였습니다. 방문 목적 유형에서는 '사적모임형'이 +24.9%p 증가하여 핵심 고객층으로 부상한 반면, '생활베이스형'은 -25.1%p 감소하였습니다. 이는 전략이 모임·사교 목적의 방문에 더 효과적으로 작용했음을 의미합니다.

**재방문율 및 고객 충성도**

전략 적용 전 고객 중 45.5%가 전략 후에도 재방문하여 기존 고객 유지 측면에서 개선의 여지가 있습니다. 신규 유입 고객 18명과 이탈 고객 30명을 고려할 때, 이탈을 줄이기 위한 추가 고객 경험 개선이 필요합니다.

**향후 권장 사항**

'사적모임형' 고객의 증가세를 유지하기 위해 해당 고객층이 선호하는 분위기·메뉴·서비스 요소를 강화하는 것을 권장합니다. 또한 Z1 세대를 주 타겟으로 한 맞춤형 마케팅 채널(SNS, 리뷰 플랫폼)을 활용하고, S 세대의 이탈 원인을 세부 분석하여 개선 방안을 수립하는 것이 중요합니다.

---

## 실행 방법

```bash
# 기본 (경로 자동 추론: data/output/{store}_before, _after)
python generate_comparison_report.py --target-store 돼지야

# 경로 직접 지정
python generate_comparison_report.py \
  --target-store 돼지야 \
  --before-dir data/output/돼지야_before \
  --after-dir  data/output/돼지야_after \
  --output-dir reports

# OpenAI API 키 지정 (없으면 규칙 기반 요약)
python generate_comparison_report.py --target-store 돼지야 --openai-key sk-...
```

## 출력 파일 구조

```
reports/
├── Comparison_Report.md          ← 최종 보고서
└── figures/
    ├── 01_wordcloud.png          ← 지표 1: 워드클라우드
    ├── 02_rating_spread.png      ← 지표 2: KDE 평점 분포
    ├── 02b_satisfaction_rate.png ← 지표 2: 만족도 막대
    ├── 03_hourly_traffic.png     ← 지표 3: 시간대별 트래픽
    ├── 04_generation_impact.png  ← 지표 4: 세대별 증감
    ├── 05_purpose_analysis.png   ← 지표 5: 방문 목적 분석
    ├── 06_retention.png          ← 지표 6: 재방문율
    └── 07_radar_chart.png        ← 지표 7: 경쟁 레이더 차트
```

---

*`ComparisonReportGenerator` — ABM Simulation Analysis Guide*
